# One-shot Job: enable Transit + KV v2 engines, create the p8-master key
#
# Runs after OpenBao is initialized and unsealed. Idempotent â€” safe to re-run.
# Reads the root token from openbao-unseal-keys secret (created by init-openbao.sh).
apiVersion: batch/v1
kind: Job
metadata:
  name: openbao-init-transit
  labels:
    app.kubernetes.io/name: openbao
    app.kubernetes.io/component: kms
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app.kubernetes.io/name: openbao-init
        app.kubernetes.io/component: kms
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-openbao
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until wget -qO- http://openbao.p8.svc.cluster.local:8200/v1/sys/health >/dev/null 2>&1; do
                echo "Waiting for OpenBao..."
                sleep 2
              done
              echo "OpenBao is ready"
      containers:
        - name: init-transit
          image: quay.io/openbao/openbao:2
          command:
            - sh
            - -c
            - |
              export BAO_ADDR=http://openbao.p8.svc.cluster.local:8200
              export BAO_TOKEN=$VAULT_TOKEN

              echo "Enabling transit secrets engine..."
              bao secrets enable transit 2>/dev/null || echo "Transit already enabled"

              echo "Creating p8-master transit key..."
              bao write -f transit/keys/p8-master type=aes256-gcm96 2>/dev/null || echo "Key already exists"

              echo "Enabling KV v2 secrets engine..."
              bao secrets enable -version=2 -path=secret kv 2>/dev/null || echo "KV v2 already enabled"

              echo "Engines ready."
              bao read transit/keys/p8-master
              bao secrets list
          env:
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: openbao-unseal-keys
                  key: root_token
          resources:
            requests:
              memory: "32Mi"
              cpu: "50m"
            limits:
              memory: "64Mi"
              cpu: "100m"
