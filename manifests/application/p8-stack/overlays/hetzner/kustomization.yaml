# Kustomize Overlay: Hetzner p8-w-1 Cluster
#
# Deploys the p8 stack to Hetzner with:
# - nginx ingress + cert-manager TLS
# - CloudNativePG PostgreSQL (single instance)
# - Plain K8s Secrets (no ExternalSecrets)
#
# Usage:
#   kubectl --context=p8-w-1 apply -k manifests/application/p8-stack/overlays/hetzner/
#
# Generate postgres init ConfigMap first:
#   kubectl create configmap p8-postgres-init-sql \
#     --from-file=install_entities.sql=sql/install_entities.sql \
#     --from-file=install.sql=sql/install.sql \
#     -n p8 --dry-run=client -o yaml | kubectl apply -f -

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: p8

resources:
  - ../../base
  - namespace.yaml
  - secrets.yaml
  - ../../../../platform/otel-collector
  - ../../../../platform/openbao

commonLabels:
  environment: hetzner

images:
  - name: percolationlabs/p8
    newName: percolationlabs/p8k8
    newTag: latest

configMapGenerator:
  - name: p8-config
    behavior: merge
    literals:
      - ENVIRONMENT=hetzner
      - LOG_LEVEL=info
      - P8_OTEL_ENABLED=true
      - P8_OTEL_SERVICE_NAME=p8-api
      - P8_OTEL_COLLECTOR_ENDPOINT=http://otel-collector.p8.svc.cluster.local:4318
      - P8_OTEL_PROTOCOL=http
      - AUTH__ENABLED=true
      - P8_S3_ENDPOINT_URL=https://fsn1.your-objectstorage.com
      - P8_S3_BUCKET=p8-percolate
      - P8_S3_REGION=fsn1
      # APNs (push notifications)
      - P8_APNS_BUNDLE_ID=ai.percolationlabs.remapp
      - P8_APNS_ENVIRONMENT=production
      # KMS — OpenBao Transit (in-cluster)
      - P8_KMS_PROVIDER=vault
      - P8_KMS_VAULT_URL=http://openbao.p8.svc.cluster.local:8200
      - P8_KMS_VAULT_TRANSIT_KEY=p8-master

  - name: p8-version-info
    behavior: merge
    literals:
      - ENVIRONMENT=hetzner

patches:
  # Ingress — replace ALB-style with nginx + cert-manager
  - path: ingress-patch.yaml
    target:
      kind: Ingress
      name: p8-api

  # Postgres — single instance, no backups for now
  - target:
      kind: Cluster
      name: p8-postgres
    patch: |
      - op: replace
        path: /spec/instances
        value: 1
      - op: replace
        path: /spec/storage/size
        value: "20Gi"

  # Inject Phoenix credentials into OTEL collector
  - target:
      kind: Deployment
      name: otel-collector
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/env
        value:
          - name: PHOENIX_API_KEY
            valueFrom:
              secretKeyRef:
                name: p8-app-secrets
                key: PHOENIX_API_KEY
          - name: PHOENIX_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: p8-app-secrets
                key: PHOENIX_ENDPOINT
