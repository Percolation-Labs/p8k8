# Kustomize Overlay: Hetzner p8-w-1 Cluster
#
# Deploys the p8 stack to Hetzner with:
# - nginx ingress + cert-manager TLS
# - CloudNativePG PostgreSQL (single instance)
# - ESO-managed secrets from OpenBao KV v2
#
# Usage:
#   kubectl --context=p8-w-1 apply -k manifests/application/p8-stack/overlays/hetzner/
#
# Generate postgres init ConfigMap first:
#   kubectl create configmap p8-postgres-init-sql \
#     --from-file=01_install_entities.sql=sql/01_install_entities.sql \
#     --from-file=02_install.sql=sql/02_install.sql \
#     --from-file=03_qms.sql=sql/03_qms.sql \
#     --from-file=04_payments.sql=sql/04_payments.sql \
#     -n p8 --dry-run=client -o yaml | kubectl apply -f -

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: p8

resources:
  - ../../base
  - namespace.yaml
  # secrets.yaml removed — now managed by ESO ExternalSecrets from OpenBao KV v2
  # Bootstrap: create openbao-eso-token, then seed-openbao.sh, then apply -k
  - ../../../../platform/otel-collector
  - ../../../../platform/openbao
  - ../../../../platform/external-secrets

commonLabels:
  environment: hetzner

images:
  - name: percolationlabs/p8
    newName: percolationlabs/p8k8
    newTag: latest

configMapGenerator:
  - name: p8-config
    behavior: merge
    literals:
      - ENVIRONMENT=hetzner
      - LOG_LEVEL=info
      - P8_OTEL_ENABLED=true
      - P8_OTEL_SERVICE_NAME=p8-api
      - P8_OTEL_COLLECTOR_ENDPOINT=http://otel-collector.p8.svc.cluster.local:4318
      - P8_OTEL_PROTOCOL=http
      - AUTH__ENABLED=true
      - P8_S3_ENDPOINT_URL=https://fsn1.your-objectstorage.com
      - P8_S3_BUCKET=p8-percolate
      - P8_S3_REGION=fsn1
      # APNs (push notifications)
      - P8_APNS_BUNDLE_ID=ai.percolationlabs.remapp
      - P8_APNS_ENVIRONMENT=production
      # KMS — OpenBao Transit (in-cluster)
      - P8_KMS_PROVIDER=vault
      - P8_KMS_VAULT_URL=http://openbao.p8.svc.cluster.local:8200
      - P8_KMS_VAULT_TRANSIT_KEY=p8-master
      # Auth token expiry
      - P8_AUTH_ACCESS_TOKEN_EXPIRY=3600
      - P8_AUTH_REFRESH_TOKEN_EXPIRY=2592000
      - P8_AUTH_MAGIC_LINK_EXPIRY=600
      # Email — Microsoft Graph (OAuth2 client credentials)
      - P8_EMAIL_PROVIDER=microsoft_graph
      - P8_EMAIL_FROM=saoirse@percolationlabs.ai
      - P8_SMTP_HOST=
      - P8_SMTP_PORT=587
      - P8_MAGIC_LINK_BASE_URL=

  - name: p8-version-info
    behavior: merge
    literals:
      - ENVIRONMENT=hetzner

patches:
  # Ingress — replace ALB-style with nginx + cert-manager
  - path: ingress-patch.yaml
    target:
      kind: Ingress
      name: p8-api

  # Postgres — single instance, no backups for now
  - target:
      kind: Cluster
      name: p8-postgres
    patch: |
      - op: replace
        path: /spec/instances
        value: 1
      - op: replace
        path: /spec/storage/size
        value: "20Gi"

