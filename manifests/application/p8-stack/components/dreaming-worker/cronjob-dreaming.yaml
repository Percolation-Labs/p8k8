---
# p8 Dreaming Worker CronJob
# Runs daily memory indexing: user models, moments, resource affinity
apiVersion: batch/v1
kind: CronJob
metadata:
  name: p8-dreaming-worker
  labels:
    app: p8-dreaming
    component: worker
spec:
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid

  jobTemplate:
    metadata:
      labels:
        app: p8-dreaming
        component: worker
    spec:
      ttlSecondsAfterFinished: 3600
      backoffLimit: 1

      template:
        metadata:
          labels:
            app: p8-dreaming
            component: worker
        spec:
          restartPolicy: Never
          serviceAccountName: p8-app

          containers:
          - name: dreaming-worker
            image: percolationlabs/p8:latest
            imagePullPolicy: Always

            command: ["p8", "moments", "--type", "session_chunk"]

            env:
            - name: P8_OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: p8-llm-api-keys
                  key: openai-api-key

            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: p8-database-credentials
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: p8-database-credentials
                  key: password
            - name: P8_DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@p8-postgres-rw.p8.svc.cluster.local:5432/p8db"

            resources:
              requests:
                memory: "256Mi"
                cpu: "250m"
              limits:
                memory: "512Mi"
                cpu: "1000m"
