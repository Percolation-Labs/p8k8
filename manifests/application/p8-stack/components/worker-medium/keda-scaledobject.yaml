apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: p8-worker-medium-scaler
  labels:
    app.kubernetes.io/name: p8-worker-medium
    app.kubernetes.io/component: worker
spec:
  scaleTargetRef:
    name: p8-worker-medium
  minReplicaCount: 0
  maxReplicaCount: 3
  pollingInterval: 15
  cooldownPeriod: 60

  triggers:
    - type: postgresql
      metadata:
        query: "SELECT COALESCE(COUNT(*), 0) FROM task_queue WHERE status = 'pending' AND tier = 'medium' AND scheduled_at <= CURRENT_TIMESTAMP"
        targetQueryValue: "1"
        activationTargetQueryValue: "0"
      authenticationRef:
        name: p8-keda-pg-auth
